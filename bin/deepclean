#!/usr/bin/env bash
#
# Deep Cleanup Script
# Clears caches, removes old files, and frees disk space
#
# Usage: deepclean
#

DOTFILES_DIR="${DOTFILES_DIR:-$HOME/.dotfiles}"
source "$DOTFILES_DIR/lib/common.sh"

log_step "Deep cleaning system"

# Homebrew
log_step "Cleaning Homebrew"
if command_exists brew; then
  brew cleanup -s --prune=all 2>/dev/null
  log_info "Homebrew cleaned"
else
  log_warn "Homebrew not installed"
fi

# npm
log_step "Cleaning npm"
if command_exists npm; then
  npm cache clean --force 2>/dev/null
  log_info "npm cache cleaned"
fi

# Xcode
log_step "Cleaning Xcode"
rm -rf ~/Library/Developer/Xcode/DerivedData/* 2>/dev/null
rm -rf ~/Library/Developer/Xcode/Archives/* 2>/dev/null
if command_exists xcrun; then
  xcrun simctl delete unavailable 2>/dev/null
fi
log_info "Xcode cleaned"

# System caches
log_step "Cleaning system caches"
rm -rf ~/Library/Caches/* 2>/dev/null
rm -rf ~/Library/Logs/* 2>/dev/null
log_info "System caches cleaned"

# Docker
if command_exists docker; then
  log_step "Cleaning Docker"
  docker system prune -af 2>/dev/null || true
  log_info "Docker cleaned"
fi

# Memory
log_step "Purging memory"
sudo purge 2>/dev/null || true
log_info "Memory purged"

# Report
echo ""
separator
echo "ðŸ’¾ Disk usage after cleanup:"
df -h /
echo ""
log_info "Deep clean complete!"
