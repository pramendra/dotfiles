#!/usr/bin/env bash
#
# Tame CPU Hogs
# Renice heavy processes to lower priority
#
# Usage: tame
#

DOTFILES_DIR="${DOTFILES_DIR:-$HOME/.dotfiles}"
source "$DOTFILES_DIR/lib/common.sh"
source "$DOTFILES_DIR/lib/process.sh"

log_step "Taming CPU hogs"

# Renice a process by name
# Usage: tame_process <name> <niceness> <description>
tame_process() {
  local name="$1"
  local nice="$2"
  local desc="${3:-$1}"

  if is_process_running "$name"; then
    pgrep -f "$name" | xargs sudo renice +"$nice" 2>/dev/null && \
      log_info "Tamed $desc (+$nice)" || \
      log_warn "Could not tame $desc"
  else
    log_debug "$desc not running"
  fi
}

# Process definitions: name, niceness, description
tame_process "DisplayLinkUserAgent"                10 "DisplayLink"
tame_process "WindowServer"                         5 "WindowServer"
tame_process "Google Chrome Helper (Renderer)"      5 "Chrome Renderers"
tame_process "mds_stores"                          15 "Spotlight"
tame_process "Dia"                                 10 "Dia Browser"
tame_process "coreaudiod"                           5 "CoreAudio"
tame_process "loginwindow"                          5 "Login Window"

echo ""
log_info "System should feel more responsive."
