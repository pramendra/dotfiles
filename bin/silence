#!/usr/bin/env bash
#
# Silence Background Agents
# Disables unnecessary launch agents/daemons (Google, Microsoft, Zoom)
# These will re-appear if you open the apps, so run this periodically.
#

echo "ðŸ”‡ Silencing noisy agents..."

# Google Keystone (Chrome Updater)
launchctl bootout system/com.google.keystone.daemon 2>/dev/null
launchctl bootout system/com.google.keystone.agent 2>/dev/null
echo "âœ… Silenced Google Keystone"

# Microsoft AutoUpdate
launchctl bootout system/com.microsoft.autoupdate.helper 2>/dev/null
launchctl bootout gui/$(id -u)/com.microsoft.update.agent 2>/dev/null
echo "âœ… Silenced Microsoft AutoUpdate"

# Microsoft Office Telemetry
launchctl bootout gui/$(id -u)/com.microsoft.SyncReporter 2>/dev/null
echo "âœ… Silenced Microsoft SyncReporter"

# Zoom Daemon
launchctl bootout system/us.zoom.ZoomDaemon 2>/dev/null
echo "âœ… Silenced Zoom Daemon"

# DisplayLink Manager
launchctl bootout gui/$(id -u) ~/Library/LaunchAgents/com.displaylink*.plist 2>/dev/null || true
echo "âœ… Silenced DisplayLink Manager"

# 1Password
launchctl bootout gui/$(id -u)/com.agilebits.onepassword7-helper 2>/dev/null
launchctl disable gui/$(id -u)/com.agilebits.onepassword7-helper 2>/dev/null
launchctl bootout gui/$(id -u)/com.1password.1password 2>/dev/null
launchctl disable gui/$(id -u)/com.1password.1password 2>/dev/null
pkill -f "1Password" 2>/dev/null || true
echo "âœ… Silenced 1Password"

# Figma Agent
launchctl bootout gui/$(id -u)/com.figma.agent 2>/dev/null
launchctl disable gui/$(id -u)/com.figma.agent 2>/dev/null
pkill -f "FigmaAgent" 2>/dev/null || true
echo "âœ… Silenced Figma Agent"

# IDrive (Persistent & Root Daemons)
echo "ðŸ” Searching for running IDrive services..."

# User agents
USER_SERVICES=$(launchctl list | grep -E "idrive|idsync" | awk '{print $3}')
for service in $USER_SERVICES; do
  echo "Killing user service: $service"
  launchctl bootout gui/$(id -u)/$service 2>/dev/null || true
  launchctl disable gui/$(id -u)/$service 2>/dev/null || true
done

# Root Daemons
if [ "$EUID" -ne 0 ]; then
  echo "âš ï¸  Checking root IDrive services (sudo required)..."
  # Reset sudo timestamp to ensure prompt if needed
  sudo -v
  
  # Find and kill root services dynamically
  ROOT_SERVICES=$(sudo launchctl list | grep -E "idrive|idsync" | awk '{print $3}')
  for service in $ROOT_SERVICES; do
    echo "Killing root service: $service"
    sudo launchctl bootout system/$service 2>/dev/null || true
    sudo launchctl disable system/$service 2>/dev/null || true
  done
  
  # Also try specific known paths for IDrive
  sudo launchctl unload -w /Library/LaunchDaemons/com.prosoftnet.idsyncdaemon.plist 2>/dev/null || true
  sudo launchctl unload -w /Library/LaunchDaemons/com.prosoftnet.idrivedaemon.plist 2>/dev/null || true
  
  # Force kill processes if they survived
  sudo pkill -9 -f "IDrive" 2>/dev/null || true
  sudo pkill -9 -f "IDSync" 2>/dev/null || true
else
  # Already root
  ROOT_SERVICES=$(launchctl list | grep -E "idrive|idsync" | awk '{print $3}')
  for service in $ROOT_SERVICES; do
    echo "Killing root service: $service"
    launchctl bootout system/$service 2>/dev/null || true
    launchctl disable system/$service 2>/dev/null || true
  done
  
  launchctl unload -w /Library/LaunchDaemons/com.prosoftnet.idsyncdaemon.plist 2>/dev/null || true
  launchctl unload -w /Library/LaunchDaemons/com.prosoftnet.idrivedaemon.plist 2>/dev/null || true
  
  pkill -9 -f "IDrive" 2>/dev/null || true
  pkill -9 -f "IDSync" 2>/dev/null || true
fi

echo "âœ… Silenced IDrive (Dynamic Discovery)"

# IDrive / Finder Extensions (The source of "FinderPluginApp")
echo "ðŸ”Œ Disabling Finder Extensions..."
EXTENSIONS=$(pluginkit -m | grep -i "idrive" | awk '{print $3}')
for ext in $EXTENSIONS; do
  echo "Disabling extension: $ext"
  pluginkit -e ignore -i "$ext" 2>/dev/null || true
done

# macOS InstantView
pkill -9 -f "macOS InstantView" 2>/dev/null || true
echo "âœ… Silenced macOS InstantView"

# FinderPluginApp (Associated with sync tools)
pkill -9 -f "FinderPluginApp" 2>/dev/null || true
echo "âœ… Silenced FinderPluginApp"

# Final sweep for any lingering processes by name
pkill -9 -f "IDrive" 2>/dev/null || true
pkill -9 -f "IDSync" 2>/dev/null || true
pkill -9 -f "Figma" 2>/dev/null || true
pkill -9 -f "1Password" 2>/dev/null || true

# Grammarly Project Llama (if unused)
# launchctl bootout gui/$(id -u)/com.grammarly.ProjectLlama.Shepherd 2>/dev/null

echo "Done. Run 'dotfiles update' manually to update these apps."
