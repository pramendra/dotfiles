#!/usr/bin/env bash
#
# Silence Background Agents
# Disables unnecessary launch agents/daemons (Google, Microsoft, Zoom, etc.)
# These will re-appear if you open the apps, so run this periodically.
#
# Usage: silence
#

# Load libraries
DOTFILES_DIR="${DOTFILES_DIR:-$HOME/.dotfiles}"
source "$DOTFILES_DIR/lib/common.sh"
source "$DOTFILES_DIR/lib/launchctl.sh"
source "$DOTFILES_DIR/lib/process.sh"

log_step "Silencing background agents"

###############################################################################
# User Launch Agents
###############################################################################

declare -a USER_AGENTS=(
  "com.google.keystone.agent"
  "com.microsoft.update.agent"
  "com.microsoft.SyncReporter"
  "com.agilebits.onepassword7-helper"
  "com.1password.1password"
  "com.figma.agent"
  "net.shinyfrog.bear.BearWidgets"
  "com.google.GoogleDrive"
)

for agent in "${USER_AGENTS[@]}"; do
  disable_user_agent "$agent"
done
log_info "Silenced ${#USER_AGENTS[@]} user agents"

###############################################################################
# System Daemons
###############################################################################

declare -a SYSTEM_DAEMONS=(
  "com.google.keystone.daemon"
  "com.microsoft.autoupdate.helper"
  "us.zoom.ZoomDaemon"
)

for daemon in "${SYSTEM_DAEMONS[@]}"; do
  disable_system_daemon "$daemon"
done
log_info "Silenced ${#SYSTEM_DAEMONS[@]} system daemons"

###############################################################################
# IDrive (Special Handling)
###############################################################################

log_step "Disabling IDrive services"

# User agents
disable_by_pattern "idrive" "user"
disable_by_pattern "idsync" "user"

# System daemons
disable_by_pattern "idrive" "system"
disable_by_pattern "idsync" "system"

# Unload known plists
unload_plist "/Library/LaunchDaemons/com.prosoftnet.idsyncdaemon.plist"
unload_plist "/Library/LaunchDaemons/com.prosoftnet.idrivedaemon.plist"

# Disable Finder extensions
log_debug "Disabling IDrive Finder extensions"
for ext in $(list_finder_extensions "idrive"); do
  disable_finder_extension "$ext"
done

log_info "Silenced IDrive"

###############################################################################
# Kill Lingering Processes
###############################################################################

log_step "Killing lingering processes"

declare -a PROCESSES=(
  "IDrive"
  "IDSync"
  "macOS InstantView"
  "FinderPluginApp"
  "Figma"
  "1Password"
  "Bear Widgets"
  "Google Drive"
)

for proc in "${PROCESSES[@]}"; do
  safe_kill "$proc"
done

###############################################################################
# Done
###############################################################################

echo ""
log_info "Done. Run 'dotfiles update' manually to update these apps."
